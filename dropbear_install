function build {
    if [[ ! -r /etc/dropbear/root_key || ! -s /etc/dropbear/root_key ]]; then
        echo '/etc/dropbear/root_key does not exist; exiting'
        return 0
    fi

    if [[ -z $TMPDIR ]]; then
        TMPDIR=/tmp/dropbear_initrd_encrypt
    fi
    mkdir -p $TMPDIR

    umask 0022

    mkdir -p /etc/dropbear/

    local keyfile=/etc/dropbear/dropbear_ed25519_host_key
    if [[ ! -s $keyfile ]]; then
        echo 'Generating Ed25519 host key for dropbear...'
        dropbearkey -t ed25519 -f "$keyfile"
        chmod +r "$keyfile.pub"
    fi

    add_checked_modules /drivers/net/
    add_binary rm
    add_binary killall
    add_binary dropbear

    add_dir /root/.ssh/
    cat /etc/dropbear/root_key > "$BUILDROOT/root/.ssh/authorized_keys"

    add_full_dir /etc/dropbear/
    add_file /lib/libnss_files.so.2
    add_dir /var/run/
    add_dir /var/log/
    touch "$BUILDROOT/var/log/lastlog"

    add_runscript
}

function help {
    cat<<HELPEOF
This hook is meant to be used in conjunction with mkinitcpio-netconf and/or
mkinitcpio-ppp. It DOES NOT provide any default shell. It will only install
and start dropbear on early userspace. In the package mkinitcpio-utils you
will find hooks and shells for remote unlocking a luks root partition,
among others.
HELPEOF
}
